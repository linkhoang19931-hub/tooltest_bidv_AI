<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ToolTest AI BIDV</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-8">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl p-6">
    <h1 class="text-2xl font-bold mb-4 text-center text-indigo-700">ToolTest AI BIDV</h1>

    <!-- Upload Excel -->
    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-1">üìÇ Ch·ªçn file Excel:</label>
      <input id="excelFile" type="file" accept=".xlsx" class="w-full border rounded px-3 py-2">
      <p class="text-sm text-gray-500 mt-1">
        File Excel c·∫ßn c√≥ c√°c c·ªôt: <b>id</b>, <b>query</b>, <b>label</b>, <b>citation_no</b>, <b>citation_title</b>
      </p>
    </div>

    <!-- Bot -->
    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-1">ü§ñ Ch·ªçn bot:</label>
      <select id="bot" class="w-full border rounded px-3 py-2">
        <option value="">-- Ch·ªçn bot --</option>
        <option value="hdqt">H·ªôi ƒë·ªìng qu·∫£n tr·ªã (HDQT)</option>
        <option value="tin_dung">T√≠n d·ª•ng</option>
      </select>
    </div>

    <!-- Group -->
    <div id="groupContainer" class="mb-4 hidden">
      <label class="block text-gray-700 font-semibold mb-1">üìö Ch·ªçn nh√≥m t√†i li·ªáu (Group):</label>
      <select id="groupSelect" class="w-full border rounded px-3 py-2">
        <option value="all">-- Ch·∫°y to√†n b·ªô group --</option>
      </select>
    </div>

    <!-- Test c≈© -->
    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-1">üóÇ Ch·ªçn test ƒë√£ ch·∫°y:</label>
      <select id="testList" class="w-full border rounded px-3 py-2">
        <option value="">-- Ch∆∞a ch·ªçn --</option>
      </select>
      <button id="refreshTestsBtn" class="text-sm text-indigo-600 mt-1 underline">üîÑ T·∫£i danh s√°ch test</button>
    </div>

    <!-- Functions -->
    <div class="mb-4">
      <label class="block text-gray-700 font-semibold mb-1">‚öôÔ∏è Ch·ª©c nƒÉng c·∫ßn ch·∫°y:</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="checkbox" value="init_test" class="func mr-2">
          üß© <b>Init Test</b> ‚Äì T·∫°o test m·ªõi
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="get_chatbot_output" class="func mr-2">
          üí¨ <b>Get Chatbot Output</b> ‚Äì L·∫•y ph·∫£n h·ªìi (response) t·ª´ bot
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="ref_check" class="func mr-2">
          üß† <b>Ref Check</b> ‚Äì Ki·ªÉm tra vƒÉn b·∫£n tham chi·∫øu (RAG)
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="get_llm_check_bone_output" class="func mr-2">
          üîç <b>LLM Check (OpenAI)</b> ‚Äì Ki·ªÉm tra n·ªôi dung tr·∫£ l·ªùi b·∫±ng LLM
        </label>
      </div>
    </div>

    <!-- Run -->
    <button id="runBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg w-full hover:bg-indigo-700">
      üöÄ B·∫Øt ƒë·∫ßu ch·∫°y
    </button>
    <button id="exportCsvBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg w-full hover:bg-green-700 mt-2">
      üì• Xu·∫•t CSV
    </button>

    <!-- Result -->
    <div id="result" class="mt-6 text-sm text-gray-800 whitespace-pre-line border-t pt-3"></div>
  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000";

    const GROUPS = {
      hdqt: [
        "quanlyruiro", "tuanthuvaphapche", "hoatdonghdqt",
        "giamsathieuqua", "chienluocvathitruong"
      ],
      tin_dung: [
        "vbcd_tiente_khoquy", "vbcd_thanhtoan", "vbcdtaichinh", "vbcd_taisan_xdcb",
        "vbcd_dichvu", "vbcd_quantri_dieuhanh_mohinhtochuc", "vbcd_tindung",
        "vbcd_quanlyruiro", "vbcdcorebanking", "vbcd_khac", "vbcdcongnghe",
        "vbcd_nhansu", "vbcdhuydongvon", "vbcd_kdvtt", "vbcd_chamsockhachhang",
        "vbcd_xulyno_totung_tranhchap", "vbcd_the", "vbcd_phancong_phancap_uyquyen", "vbcdketoan"
      ]
    };

    // Load group theo bot
    function loadGroups(bot) {
      const container = document.getElementById("groupContainer");
      const select = document.getElementById("groupSelect");
      select.innerHTML = '<option value="all">-- Ch·∫°y to√†n b·ªô group --</option>';
      if (!bot || !GROUPS[bot]) {
        container.classList.add("hidden");
        return;
      }
      GROUPS[bot].forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        select.appendChild(opt);
      });
      container.classList.remove("hidden");
    }

    // Load test ƒë√£ ch·∫°y
    async function loadTests() {
      const bot = document.getElementById("bot").value;
      const testList = document.getElementById("testList");
      testList.innerHTML = "<option value=''>-- Ch∆∞a ch·ªçn --</option>";
      if (!bot) return;

      try {
        const res = await fetch(`${API_BASE}/list_tests?bot=${bot}`);
        const data = await res.json();
        if (!data.status) throw new Error(data.error || "Kh√¥ng c√≥ d·ªØ li·ªáu");
        data.data.forEach(t => {
          const time = new Date(t.start_time * 1000).toLocaleString("vi-VN");
          const opt = document.createElement("option");
          opt.value = t.test_run_id;
          opt.textContent = `${time} | ${t.file_name} | ID=${t.test_run_id}`;
          testList.appendChild(opt);
        });
      } catch (err) {
        alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch test: " + err);
      }
    }

    document.getElementById("refreshTestsBtn").addEventListener("click", loadTests);
    document.getElementById("bot").addEventListener("change", e => {
      const bot = e.target.value;
      loadGroups(bot);
      loadTests();
    });

    // Run
    document.getElementById("runBtn").addEventListener("click", async () => {
      const bot = document.getElementById("bot").value;
      const funcs = Array.from(document.querySelectorAll(".func:checked")).map(el => el.value);
      const testId = document.getElementById("testList").value;
      const group = document.getElementById("groupSelect").value;
      const file = document.getElementById("excelFile").files[0];
      const resultDiv = document.getElementById("result");

      if (!bot || funcs.length === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn bot v√† √≠t nh·∫•t m·ªôt ch·ª©c nƒÉng!");
        return;
      }

      const formData = new FormData();
      formData.append("bot", bot);
      formData.append("functions", funcs.join(","));
      if (group && group !== "all") formData.append("group", group);
      if (file) formData.append("file", file);
      if (testId) formData.append("test_id", testId);

      resultDiv.textContent = "‚è≥ ƒêang ch·∫°y, vui l√≤ng ƒë·ª£i...";
      try {
        const res = await fetch(`${API_BASE}/run`, { method: "POST", body: formData });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Kh√¥ng r√µ nguy√™n nh√¢n");
        resultDiv.textContent = `‚úÖ Ho√†n t·∫•t!\n${data.message || ""}\n\n${data.stdout?.slice(-700) || ""}`;
      } catch (err) {
        resultDiv.textContent = `‚ùå L·ªói: ${err}`;
      }
    });

    // Export CSV
    document.getElementById("exportCsvBtn").addEventListener("click", async () => {
      const bot = document.getElementById("bot").value;
      const testId = document.getElementById("testList").value;
      if (!bot || !testId) {
        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn bot v√† test ƒë·ªÉ xu·∫•t CSV!");
        return;
      }

      try {
        const url = `${API_BASE}/export_csv?bot=${bot}&test_run_id=${testId}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i CSV");
        const blob = await res.blob();
        const blobUrl = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = blobUrl;
        a.download = `output_${bot}_${testId}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(blobUrl);
      } catch (err) {
        alert("‚ùå L·ªói khi t·∫£i CSV: " + err);
      }
    });
  </script>
</body>
</html>
